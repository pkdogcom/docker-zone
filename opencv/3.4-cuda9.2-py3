FROM nvidia/cuda:9.2-cudnn7-devel-ubuntu18.04
LABEL maintainer pkdogcom@gmail.com

RUN apt-get update && apt-get upgrade -y && apt-get install -y \
        build-essential cmake pkg-config unzip git wget && \
    apt-get install -y --no-install-recommends \
	ffmpeg qtbase5-dev python3-dev python3-numpy python3-py \
	libgtk-3-dev libturbojpeg libpng-dev libtiff-dev zlib1g-dev libglew-dev libprotobuf-dev \ 
	libavcodec-dev libavformat-dev libavutil-dev libswscale-dev libxine2-dev libx264-dev \	
        libv4l-dev libtbb-dev libfaac-dev libmp3lame-dev libopencore-amrnb-dev libopencore-amrwb-dev libtheora-dev \
        libvorbis-dev libxvidcore-dev v4l-utils libhdf5-serial-dev libeigen3-dev libtbb-dev libpostproc-dev libatlas-base-dev gfortran && \
    rm -rf /var/lib/apt/lists/*

# Build OpenCV with CUDA
RUN \
    cd ~ && \ 
    git clone https://github.com/Itseez/opencv.git && cd opencv && git checkout 3.4.5 && cd .. && \
    git clone https://github.com/Itseez/opencv_contrib.git && cd opencv_contrib && git checkout 3.4.5 && \ 
    cd ~/opencv && \ 
    mkdir build && \ 
    cd build && \
    cmake \
	-DCMAKE_BUILD_TYPE=Release \
	-DCMAKE_INSTALL_PREFIX=/usr/local \
	-DBUILD_EXAMPLES=OFF \
	-DBUILD_opencv_java=OFF \
	-DBUILD_opencv_python2=OFF \
	-DBUILD_opencv_python3=ON \
	-DBUILD_JPEG=ON \
	-DWITH_JPEG=ON \
	-DWITH_PNG=ON \
	-DWITH_TIFF=ON \
	-DWITH_FFMPEG=ON \
	-DWITH_CUDA=ON \
	-DWITH_GTK=ON \
	-DWITH_TBB=ON \
	-DWITH_V4L=ON \
	-DWITH_QT=ON \
	-DWITH_OPENGL=ON \
	-DWITH_CUBLAS=ON \	
    -DWITH_1394=OFF \
	-DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-9.2 \
	-DCUDA_ARCH_PTX="" \
	-DCUDA_NVCC_FLAGS="-D_FORCE_INLINES" \ 
	-DCMAKE_LIBRARY_PATH=/usr/local/cuda/lib64/stubs \
	-DINSTALL_C_EXAMPLES=OFF \
	-DINSTALL_TESTS=OFF \
	-DOPENCV_EXTRA_MODULES_PATH=~/opencv_contrib/modules .. && \
    make -j $(nproc) && make install && ldconfig && \
    rm -rf ~/opencv/build 
    

    

    

